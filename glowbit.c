/**
 * Based on code example from RPi SDK
 * adapted by John Lamb
 * Copyright (c) 2020 Raspberry Pi (Trading) Ltd.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

#include <stdio.h>
#include <stdlib.h>

#include "pico/stdlib.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"
#include "ws2812.pio.h"

#define IS_RGBW false   // Glowbit uses WS2812B RGB 8 bits each ie 24 bits
#define NUM_PIXELS 64   // Glowbit Matrix 8x8 uses an 8x8 matrix

#ifdef PICO_DEFAULT_WS2812_PIN
#define WS2812_PIN PICO_DEFAULT_WS2812_PIN
#else
// default to pin 2 if the board doesn't have a default WS2812 pin defined
#define WS2812_PIN 2
#endif

#include <malloc.h>

uint32_t getTotalHeap(void) {
   extern char __StackLimit, __bss_end__;
      printf("Total Heap Size: %d\n", &__StackLimit  - &__bss_end__);
      return &__StackLimit  - &__bss_end__;
}

uint32_t getFreeHeap(void) {
   struct mallinfo m = mallinfo();

   printf("approx memory remaining: %d\n", getTotalHeap() - m.uordblks);
}


static inline void put_pixel(uint32_t pixel_grb) {
    pio_sm_put_blocking(pio0, 0, pixel_grb << 8u);
}

static inline uint32_t urgb_u32(uint8_t r, uint8_t g, uint8_t b) {
    return
            ((uint32_t) (r) << 8) |
            ((uint32_t) (g) << 16) |
            (uint32_t) (b);
}

void pattern_snakes(uint len, uint t) {
    for (uint i = 0; i < len; ++i) {
        uint x = (i + (t >> 1)) % 64;
        if (x < 10)
            put_pixel(urgb_u32(0xff, 0, 0));
        else if (x >= 15 && x < 25)
            put_pixel(urgb_u32(0, 0xff, 0));
        else if (x >= 30 && x < 40)
            put_pixel(urgb_u32(0, 0, 0xff));
        else
            put_pixel(0);
    }
}

void pattern_random(uint len, uint t) {
    if (t % 8)
        return;
    for (int i = 0; i < len; ++i)
        put_pixel(rand());
}

void pattern_sparkle(uint len, uint t) {
    if (t % 8)
        return;
    for (int i = 0; i < len; ++i)
        put_pixel(rand() % 16 ? 0 : 0xffffffff);
}

void pattern_greys(uint len, uint t) {
    int max = 100; // let's not draw too much current!
    t %= max;
    for (int i = 0; i < len; ++i) {
        put_pixel(t * 0x10101);
        if (++t >= max) t = 0;
    }
}

void pattern_red(uint len, uint t) {
    for (int i = 0; i < len; ++i)
        put_pixel(urgb_u32(0x60, 0, 0));
}

void pattern_black(uint len, uint t){
   for (int i = 0; i < len; ++i)
        put_pixel(urgb_u32(0, 0, 0));
}

const int8_t __in_flash() fontmap [] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // 32=                             
    0x00,0x00,0x00,0x4f,0x4f,0x00,0x00,0x00, // 33=!                            
    0x00,0x07,0x07,0x00,0x00,0x07,0x07,0x00, // 34="                            
    0x14,0x7f,0x7f,0x14,0x14,0x7f,0x7f,0x14, // 35=//                            
    0x00,0x24,0x2e,0x6b,0x6b,0x3a,0x12,0x00, // 36=$                            
    0x00,0x63,0x33,0x18,0x0c,0x66,0x63,0x00, // 37=%                            
    0x00,0x32,0x7f,0x4d,0x4d,0x77,0x72,0x50, // 38=&                            
    0x00,0x00,0x00,0x04,0x06,0x03,0x01,0x00, // 39='                            
    0x00,0x00,0x1c,0x3e,0x63,0x41,0x00,0x00, // 40=(                            
    0x00,0x00,0x41,0x63,0x3e,0x1c,0x00,0x00, // 41=)                            
    0x08,0x2a,0x3e,0x1c,0x1c,0x3e,0x2a,0x08, // 42=*                            
    0x00,0x08,0x08,0x3e,0x3e,0x08,0x08,0x00, // 43=+                            
    0x00,0x00,0x80,0xe0,0x60,0x00,0x00,0x00, // 44=,                            
    0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00, // 45=-                            
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00, // 46=.                            
    0x00,0x40,0x60,0x30,0x18,0x0c,0x06,0x02, // 47=/                            
    0x00,0x3e,0x7f,0x49,0x45,0x7f,0x3e,0x00, // 48=0                            
    0x00,0x40,0x44,0x7f,0x7f,0x40,0x40,0x00, // 49=1                            
    0x00,0x62,0x73,0x51,0x49,0x4f,0x46,0x00, // 50=2                            
    0x00,0x22,0x63,0x49,0x49,0x7f,0x36,0x00, // 51=3                            
    0x00,0x18,0x18,0x14,0x16,0x7f,0x7f,0x10, // 52=4                            
    0x00,0x27,0x67,0x45,0x45,0x7d,0x39,0x00, // 53=5                            
    0x00,0x3e,0x7f,0x49,0x49,0x7b,0x32,0x00, // 54=6                            
    0x00,0x03,0x03,0x79,0x7d,0x07,0x03,0x00, // 55=7                            
    0x00,0x36,0x7f,0x49,0x49,0x7f,0x36,0x00, // 56=8                            
    0x00,0x26,0x6f,0x49,0x49,0x7f,0x3e,0x00, // 57=9                            
    0x00,0x00,0x00,0x24,0x24,0x00,0x00,0x00, // 58=:                            
    0x00,0x00,0x80,0xe4,0x64,0x00,0x00,0x00, // 59=;                            
    0x00,0x08,0x1c,0x36,0x63,0x41,0x41,0x00, // 60=<                            
    0x00,0x14,0x14,0x14,0x14,0x14,0x14,0x00, // 61==                            
    0x00,0x41,0x41,0x63,0x36,0x1c,0x08,0x00, // 62=>                            
    0x00,0x02,0x03,0x51,0x59,0x0f,0x06,0x00, // 63=?                            
    0x00,0x3e,0x7f,0x41,0x4d,0x4f,0x2e,0x00, // 64=@                            
    0x00,0x7c,0x7e,0x0b,0x0b,0x7e,0x7c,0x00, // 65=A                            
    0x00,0x7f,0x7f,0x49,0x49,0x7f,0x36,0x00, // 66=B                            
    0x00,0x3e,0x7f,0x41,0x41,0x63,0x22,0x00, // 67=C                            
    0x00,0x7f,0x7f,0x41,0x63,0x3e,0x1c,0x00, // 68=D                            
    0x00,0x7f,0x7f,0x49,0x49,0x41,0x41,0x00, // 69=E                            
    0x00,0x7f,0x7f,0x09,0x09,0x01,0x01,0x00, // 70=F                            
    0x00,0x3e,0x7f,0x41,0x49,0x7b,0x3a,0x00, // 71=G                            
    0x00,0x7f,0x7f,0x08,0x08,0x7f,0x7f,0x00, // 72=H                            
    0x00,0x00,0x41,0x7f,0x7f,0x41,0x00,0x00, // 73=I                            
    0x00,0x20,0x60,0x41,0x7f,0x3f,0x01,0x00, // 74=J                            
    0x00,0x7f,0x7f,0x1c,0x36,0x63,0x41,0x00, // 75=K                            
    0x00,0x7f,0x7f,0x40,0x40,0x40,0x40,0x00, // 76=L                            
    0x00,0x7f,0x7f,0x06,0x0c,0x06,0x7f,0x7f, // 77=M                            
    0x00,0x7f,0x7f,0x0e,0x1c,0x7f,0x7f,0x00, // 78=N                            
    0x00,0x3e,0x7f,0x41,0x41,0x7f,0x3e,0x00, // 79=O                            
    0x00,0x7f,0x7f,0x09,0x09,0x0f,0x06,0x00, // 80=P                            
    0x00,0x1e,0x3f,0x21,0x61,0x7f,0x5e,0x00, // 81=Q                            
    0x00,0x7f,0x7f,0x19,0x39,0x6f,0x46,0x00, // 82=R                            
    0x00,0x26,0x6f,0x49,0x49,0x7b,0x32,0x00, // 83=S                            
    0x00,0x01,0x01,0x7f,0x7f,0x01,0x01,0x00, // 84=T                            
    0x00,0x3f,0x7f,0x40,0x40,0x7f,0x3f,0x00, // 85=U                            
    0x00,0x1f,0x3f,0x60,0x60,0x3f,0x1f,0x00, // 86=V                            
    0x00,0x7f,0x7f,0x30,0x18,0x30,0x7f,0x7f, // 87=W                            
    0x00,0x63,0x77,0x1c,0x1c,0x77,0x63,0x00, // 88=X                            
    0x00,0x07,0x0f,0x78,0x78,0x0f,0x07,0x00, // 89=Y                            
    0x00,0x61,0x71,0x59,0x4d,0x47,0x43,0x00, // 90=Z                            
    0x00,0x00,0x7f,0x7f,0x41,0x41,0x00,0x00, // 91=[                            
    0x00,0x02,0x06,0x0c,0x18,0x30,0x60,0x40, // 92='\'                          
    0x00,0x00,0x41,0x41,0x7f,0x7f,0x00,0x00, // 93=]                            
    0x00,0x08,0x0c,0x06,0x06,0x0c,0x08,0x00, // 94=^                            
    0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0, // 95=_                            
    0x00,0x00,0x01,0x03,0x06,0x04,0x00,0x00, // 96=`                            
    0x00,0x20,0x74,0x54,0x54,0x7c,0x78,0x00, // 97=a                            
    0x00,0x7f,0x7f,0x44,0x44,0x7c,0x38,0x00, // 98=b                            
    0x00,0x38,0x7c,0x44,0x44,0x6c,0x28,0x00, // 99=c                            
    0x00,0x38,0x7c,0x44,0x44,0x7f,0x7f,0x00, // 100=d                           
    0x00,0x38,0x7c,0x54,0x54,0x5c,0x58,0x00, // 101=e                           
    0x00,0x08,0x7e,0x7f,0x09,0x03,0x02,0x00, // 102=f                           
    0x00,0x98,0xbc,0xa4,0xa4,0xfc,0x7c,0x00, // 103=g                           
    0x00,0x7f,0x7f,0x04,0x04,0x7c,0x78,0x00, // 104=h                           
    0x00,0x00,0x00,0x7d,0x7d,0x00,0x00,0x00, // 105=i                           
    0x00,0x40,0xc0,0x80,0x80,0xfd,0x7d,0x00, // 106=j                           
    0x00,0x7f,0x7f,0x30,0x38,0x6c,0x44,0x00, // 107=k                           
    0x00,0x00,0x41,0x7f,0x7f,0x40,0x00,0x00, // 108=l                           
    0x00,0x7c,0x7c,0x18,0x30,0x18,0x7c,0x7c, // 109=m                           
    0x00,0x7c,0x7c,0x04,0x04,0x7c,0x78,0x00, // 110=n                           
    0x00,0x38,0x7c,0x44,0x44,0x7c,0x38,0x00, // 111=o                           
    0x00,0xfc,0xfc,0x24,0x24,0x3c,0x18,0x00, // 112=p                           
    0x00,0x18,0x3c,0x24,0x24,0xfc,0xfc,0x00, // 113=q                           
    0x00,0x7c,0x7c,0x04,0x04,0x0c,0x08,0x00, // 114=r                           
    0x00,0x48,0x5c,0x54,0x54,0x74,0x20,0x00, // 115=s                           
    0x04,0x04,0x3f,0x7f,0x44,0x64,0x20,0x00, // 116=t                           
    0x00,0x3c,0x7c,0x40,0x40,0x7c,0x3c,0x00, // 117=u                           
    0x00,0x1c,0x3c,0x60,0x60,0x3c,0x1c,0x00, // 118=v                           
    0x00,0x1c,0x7c,0x30,0x18,0x30,0x7c,0x1c, // 119=w                           
    0x00,0x44,0x6c,0x38,0x38,0x6c,0x44,0x00, // 120=x                           
    0x00,0x9c,0xbc,0xa0,0xa0,0xfc,0x7c,0x00, // 121=y                           
    0x00,0x44,0x64,0x74,0x5c,0x4c,0x44,0x00, // 122=z                           
    0x00,0x08,0x08,0x3e,0x77,0x41,0x41,0x00, // 123={                           
    0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00, // 124=|                           
    0x00,0x41,0x41,0x77,0x3e,0x08,0x08,0x00, // 125=}                           
    0x00,0x02,0x03,0x01,0x03,0x02,0x03,0x01, // 126=~                           
    0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55, // 127
     };
    
    const int8_t three_bits [] = {0x00,0x22,0x63,0x49,0x49,0x7f,0x36,0x00};



void display3 (){
    int fMapOffset = 8;
    //printf("fontmap: %p ", &fontmap);
    int8_t debugrow = fontmap[fMapOffset];
    getFreeHeap();
    getTotalHeap();
    //printf("debugrow: %p\n", &debugrow);
    for (int i=fMapOffset; i < fMapOffset+8; i++){
        int8_t row = fontmap[i];
        for (int j = 0; j<8; j++){
            bool pixel = (row << j) & 0b10000000;
            if (pixel) put_pixel(urgb_u32(0x50, 0x50, 0x50));
            else put_pixel(urgb_u32(0, 0, 0));
        }
    }
}


typedef void (*pattern)(uint len, uint t);
const struct {
    pattern pat;
    const char *name;
} pattern_table[] = {
        {pattern_snakes,  "Snakes!"},
        {pattern_random,  "Random data"},
        {pattern_sparkle, "Sparkles"},
        {pattern_greys,   "Greys"},
        {pattern_red,   "Red"}
};

int main() {
    //set_sys_clock_48();
    stdio_init_all();
    printf("WS2812B using GPIO %d\n", WS2812_PIN);

    // todo get free sm
    PIO pio = pio0;
    int sm = 0;
    uint offset = pio_add_program(pio, &ws2812_program);

    ws2812_program_init(pio, sm, offset, WS2812_PIN, 800000, IS_RGBW);

    getFreeHeap();
    getTotalHeap();

    while (1) {
        pattern_black(NUM_PIXELS, 0);
        sleep_ms(500);
        display3();
        sleep_ms(500);
    }
}
